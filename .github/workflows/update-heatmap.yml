name: Update Cavriana Heatmap

on:
  push:
    branches: [ main ]
    paths:
      - "letters/*.xml"
      - "letter_parser.py"
      - "cavriana_heatmap.py"

jobs:
  update-heatmap:
    runs-on: ubuntu-latest

    steps:
    # 1 ─ back-end checkout & build ───────────────────────────────────────
    - uses: actions/checkout@v4        # CavrianaCorr (root)

    - uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: ${{ runner.os }}-pip-

    - name: Install Python deps
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy lxml

    # If the scripts are in scripts/, add: working-directory: scripts
    - name: Generate letter metadata → CSV
      run: python letter_parser.py        # <— make sure path is correct

    - name: Generate CavrianaHeatmap.jsx from template
      run: python cavriana_heatmap.py     # <— idem; outputs at repo root

    # 2 ─ front-end checkout ─────────────────────────────────────────────
    - uses: actions/checkout@v4
      with:
        repository: Pantagrueliste/CavrianaCorr_FrontEnd
        path: CavrianaCorr_FrontEnd
        token: ${{ secrets.DOCUSAURUS_REPO_SECRET }}

    - name: Drop component into front-end repo
      run: |
        mkdir -p CavrianaCorr_FrontEnd/src/components
        cp CavrianaHeatmap.jsx CavrianaCorr_FrontEnd/src/components/

    # 3 ─ Docusaurus smoke-test build ────────────────────────────────────
    - uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Install front-end JS deps
      working-directory: CavrianaCorr_FrontEnd
      run: npm ci

    - name: Build site (smoke-test)
      working-directory: CavrianaCorr_FrontEnd
      run: npm run build

    # 4 ─ commit only if build passed ────────────────────────────────────
    - name: Commit & push component
      if: ${{ success() }}
      working-directory: CavrianaCorr_FrontEnd
      env:
        GH_TOKEN: ${{ secrets.DOCUSAURUS_REPO_SECRET }}   # reuse same token
      run: |
        git config user.name  "GitHub Actions"
        git config user.email "github-actions@github.com"
        git add src/components/CavrianaHeatmap.jsx
        git diff --cached --quiet || git commit -m "Auto-update Cavriana heat-map"
        # push authenticated with the same PAT
        git push https://$GH_TOKEN@github.com/Pantagrueliste/CavrianaCorr_FrontEnd.git HEAD:main
